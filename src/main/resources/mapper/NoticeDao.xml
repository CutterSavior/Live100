<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lanjii.biz.admin.notice.dao.NoticeDao">

    <!-- 通用结果集映射 -->
    <resultMap id="BaseResultMap" type="com.lanjii.biz.admin.notice.model.entity.Notice">
        <id column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="publisher_id" property="publisherId"/>
        <result column="publisher_name" property="publisherName"/>
        <result column="publish_time" property="publishTime"/>
        <result column="status" property="status"/>
        <result column="is_deleted" property="deleted"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
    </resultMap>

    <!-- 查询通知列表（带已读状态） -->
    <select id="listWithReadStatus" resultType="com.lanjii.biz.admin.notice.model.vo.NoticeVO">
        SELECT
        n.id,
        n.title,
        n.content,
        n.publisher_id,
        n.publisher_name,
        n.publish_time,
        n.status,
        CASE n.status
        WHEN 0 THEN '草稿'
        WHEN 1 THEN '已发布'
        ELSE '草稿'
        END AS status_label,
        CASE WHEN r.id IS NOT NULL THEN 1 ELSE 0 END AS read_status,
        r.read_time
        FROM sys_notice n
        LEFT JOIN sys_notice_read_record r ON n.id = r.notice_id AND r.user_id = #{userId}
        WHERE n.is_deleted = 0
        AND n.status = 1
        <if test="filter.keyword != null and filter.keyword != ''">
            AND (n.title LIKE CONCAT('%', #{filter.keyword}, '%')
            OR n.content LIKE CONCAT('%', #{filter.keyword}, '%'))
        </if>
        <if test="filter.readStatus != null">
            AND CASE WHEN r.id IS NOT NULL THEN 1 ELSE 0 END = #{filter.readStatus}
        </if>
        ORDER BY n.publish_time DESC
    </select>

    <!-- 根据ID查询通知（带已读状态） -->
    <select id="getByIdWithReadStatus" resultType="com.lanjii.biz.admin.notice.model.vo.NoticeVO">
        SELECT
            n.id,
            n.title,
            n.content,
            n.publisher_id,
            n.publisher_name,
            n.publish_time,
            n.status,
            CASE n.status
                WHEN 0 THEN '草稿'
                WHEN 1 THEN '已发布'
                ELSE '草稿'
            END AS status_label,
            CASE WHEN r.id IS NOT NULL THEN 1 ELSE 0 END AS read_status,
            r.read_time
        FROM sys_notice n
        LEFT JOIN sys_notice_read_record r ON n.id = r.notice_id AND r.user_id = #{userId}
        WHERE n.id = #{noticeId}
            AND n.is_deleted = 0
    </select>

    <!-- 统计未读数量 -->
    <select id="countUnread" resultType="java.lang.Long">
        SELECT COUNT(*)
        FROM sys_notice n
        LEFT JOIN sys_notice_read_record r ON n.id = r.notice_id AND r.user_id = #{userId}
        WHERE n.is_deleted = 0
            AND n.status = 1
            AND r.id IS NULL
    </select>

    <!-- 查询最近通知（支持按阅读状态筛选） -->
    <select id="listRecentNotices" resultType="com.lanjii.biz.admin.notice.model.vo.NoticeVO">
        SELECT
            n.id,
            n.title,
            n.content,
            n.publisher_id,
            n.publisher_name,
            n.publish_time,
            n.status,
            CASE n.status
                WHEN 0 THEN '草稿'
                WHEN 1 THEN '已发布'
                ELSE '草稿'
            END AS status_label,
            CASE WHEN r.id IS NOT NULL THEN 1 ELSE 0 END AS read_status,
            r.read_time
        FROM sys_notice n
        LEFT JOIN sys_notice_read_record r ON n.id = r.notice_id AND r.user_id = #{userId}
        WHERE n.is_deleted = 0
            AND n.status = 1
            <if test="readStatus != null">
                <if test="readStatus == 0">
                    AND r.id IS NULL
                </if>
                <if test="readStatus == 1">
                    AND r.id IS NOT NULL
                </if>
            </if>
        ORDER BY n.publish_time DESC
        LIMIT #{limit}
    </select>

</mapper>
